name: consu

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - name: Set up Go env
      uses: actions/setup-go@v2
      with:
        go-version: ^1.13

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Test checksum
      run: cd ./checksum && go test -cover -covermode=atomic -count 1 -coverprofile=../coverage_checksum.txt -v . && cd ..
    - name: Test gjrc
      run: cd ./gjrc && go test -cover -covermode=atomic -count 1 -coverprofile=../coverage_gjrc.txt -v . && cd ..
    - name: Test semita
      run: cd ./semita && go test -cover -covermode=atomic -count 1 -coverprofile=../coverage_semita.txt -v . && cd ..

    - name: Upload coverage report
      run: |
        echo "" > coverage.txt
        if [ -f coverage_checksum.txt ]; then
          cat coverage_checksum.txt >> coverage.txt
          rm coverage_checksum.txt
        fi
        if [ -f coverage_gjrc.txt ]; then
          cat coverage_gjrc.txt >> coverage.txt
          rm coverage_gjrc.txt
        fi
        if [ -f coverage_semita.txt ]; then
          cat coverage_semita.txt >> coverage.txt
          rm coverage_semita.txt
        fi
        bash <(curl -s https://codecov.io/bash)
